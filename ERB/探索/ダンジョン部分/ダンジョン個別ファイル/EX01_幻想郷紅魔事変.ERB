

@ダンジョン初期処理_幻想郷紅魔異変
;ダンジョン構造の読み込み
;0でない時、そのマスは存在する
#DIM 深度
#DIM 分岐

ダンジョンサブタイトル = THE MIST OF SCARLET
ダンジョンマス画像URL_伏せ状態 = 壁_森
ダンジョン現在位置:0 = 0
ダンジョン現在位置:1 = 4
ダンジョン背景画像 = 背景_紅い霧砂浜

;スタート地点は必ず存在
;初期からオープン済みなので3を入れる
;ビット0：存在するか　ビット1：移動できるか　ビット2：マスをオープンするか（ビット１をONにしないと無意味）　ビット3：入れないがオープンする場合に使用
;ビット4以降：自由枠。主に宝箱の開閉やイベント達成フラグなどに使用
IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}") == 0
	SETVAR @"ダンジョン構造配列_%ダンジョン名%:{ダンジョン現在位置:0}:{ダンジョン現在位置:1}", 3
ENDIF

FOR 深度, 1, 100
	LOCAL = 0
	FOR 分岐, 0, 9
		IF GETVAR(@"ダンジョン構造配列_%ダンジョン名%:{深度}:{分岐}")
			;既にマス情報が入ってるなら飛ばす
			LOCAL = 1
			CONTINUE
		ELSEIF ENUMFUNCBEGINSWITH(@"ダンジョンマス情報_%ダンジョン名%_{深度}_{分岐}")
			LOCAL = 1
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:深度:分岐", 1
		ENDIF
	NEXT
	IF LOCAL
		ダンジョン最大深度 = 深度
	ENDIF
NEXT

@ダンジョン解説文_幻想郷紅魔異変

詳細文文字列受け渡し変数 = 
詳細文文字列受け渡し変数 += "紅の霧がリゾートに発生し、運営に支障が出ている。<br>"
詳細文文字列受け渡し変数 += "あなたは霧解消のために異世界の扉を潜った。<br>"
詳細文文字列受け渡し変数 += "「幻想郷」と呼ばれる異世界にて、解決策を求めて探索する。<br>"
詳細文文字列受け渡し変数 += "<br>"
詳細文文字列受け渡し変数 += "ダンジョン出典：東方project<br>"

;推奨レベルを返す
RETURN 16

@敵討伐後処理_ダンジョン固有_幻想郷紅魔異変(討伐エネミー数)
#DIM 討伐エネミー数
;ダンジョン内で戦闘した後に呼ばれる関数、主にダンジョンごとのドロップアイテム取得に使用
;今回アイテムドロップはないので記述なし

;---------------------------------------------------------------------
;固有戦闘開始時処理
;---------------------------------------------------------------------
;霊夢と魔理沙の加勢バフ
;---------------------------------------------------------------------
@固有戦闘開始時処理_特殊_霊夢の助力_紅魔事変()
;ここ２行はエラー回避のためのもの。おまじない程度においておくこと
戦闘行動キャラ = 0
CALL アビ対象選択テンプレート_自己のみ
;バフ付け文章は出さないので1を入れておく
アビテンプレート用_アビ名表示済フラグ = 1
;大元のバフセット（効果なし）
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 霊夢の助力_紅魔事変
アビ汎用文字列:バフ・デバフ対象能力 = 霊夢の助力_紅魔事変
アビ汎用変数:持続ターン = -1
アビ汎用変数:消去不可オプション = 1
アビ汎用変数:特殊表示オプション = 1
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_バフ効果セット
;回避UP部分
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 霊夢の助力_紅魔事変_回避率
アビ汎用文字列:バフ・デバフ対象能力 = 回避率
アビ汎用変数:効果量 = 15
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_付随バフ効果セット("霊夢の助力_紅魔事変")
;カウンター部分
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 霊夢の助力_紅魔事変_援護攻撃
アビ汎用文字列:バフ・デバフ対象能力 = 特殊反応_回避時
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_付随バフ効果セット("霊夢の助力_紅魔事変")

;メッセージは出さないのでここでリセット
CALL アビテンプレ変数リセット

@特殊反応_回避時_霊夢の助力_紅魔事変_援護攻撃(バフ番号, 攻撃者隊列, 回避記録順)
#DIM 回避記録順
#DIM 攻撃者隊列
#DIM バフ番号
#DIMS 立ち絵_霊夢

;立ち絵リソース記録に必要な画像のリソースを生成する
CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),100,,,1,1)
立ち絵_霊夢 = %立ち絵リソース記録%

;顔グラ込みのセリフを出す
WSTR:(K++) = 「%TEXTR("そこっ！/隙だらけね/貰ったわ！")%」
CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
CALL 口上変数初期化

;攻撃処理
CALL アビテンプレ変数リセット
CALL アビ対象選択テンプレート_指定(攻撃者隊列)
アビテンプレート用_アビ名 = 霊夢の援護攻撃

アビ汎用文字列:実行時メッセージ１ = 霊夢の援護攻撃！
アビ汎用変数:効果量 = 500
CALL アビテンプレート_ダメージ処理_光属性

CALL アビテンプレート用_表示メッセージ変換処理
CALL メッセージ欄表示用関数(,,,0)
CALL 口上変数初期化

@バフ・デバフ特殊表示_霊夢の助力_紅魔事変(隊列番号, バフ・デバフ行数)
#DIM 隊列番号
#DIM バフ・デバフ行数
VARSET LOCALS

PRINTFORML 霊夢の助力
PRINTFORML 回避率+15％・回避時に霊夢が援護攻撃を放つ［消去不可］
PRINTFORML 持続ターン：永続

@固有戦闘開始時処理_特殊_魔理沙の助力_紅魔事変()
;ここ２行はエラー回避のためのもの。おまじない程度においておくこと
戦闘行動キャラ = 0
CALL アビ対象選択テンプレート_自己のみ
;バフ付け文章は出さないので1を入れておく
アビテンプレート用_アビ名表示済フラグ = 1
;大元のバフセット（効果なし）
CALL アビ汎用変数文字列リセット
アビ汎用文字列:バフ・デバフ枠 = 魔理沙の助力_紅魔事変
アビ汎用文字列:バフ・デバフ対象能力 = 攻撃力
アビ汎用変数:効果割合 = 30
アビ汎用変数:持続ターン = -1
アビ汎用変数:消去不可オプション = 1
アビ汎用変数:特殊表示オプション = 1
アビ汎用文字列:適用範囲 = 味方全体
CALL アビテンプレート_有利効果_バフ効果セット

;メッセージは出さないのでここでリセット
CALL アビテンプレ変数リセット

@バフ・デバフ特殊表示_魔理沙の助力_紅魔事変(隊列番号, バフ・デバフ行数)
#DIM 隊列番号
#DIM バフ・デバフ行数
VARSET LOCALS

PRINTFORML 魔理沙の助力
PRINTFORML 攻撃力+30％［消去不可］
PRINTFORML 持続ターン：永続

@固有戦闘開始時処理_特殊_霊夢と魔理沙の助力_紅魔事変()
CALL 固有戦闘開始時処理_特殊_霊夢の助力_紅魔事変()
CALL 固有戦闘開始時処理_特殊_魔理沙の助力_紅魔事変()

;---------------------------------------------------------------------
;マップ構造
;---------------------------------------------------------------------
;イベントミニマップなのでほぼ一本道、途中ちょっとだけ分岐
;---------------------------------------------------------------------

@ダンジョンマス情報_幻想郷紅魔異変_0_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 0
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "2_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 紅い霧が立ち込めた湖畔だ。
			CALL 再視聴確認(1)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			WSTR:(K++) = 異世界への門をくぐり、紅い霧を辿りながら進むと一つの世界に到着した。
			WSTR:(K++) = ここが幻想郷か。
			WSTR:(K++) = 周囲には濃い紅い霧があり、よく見えないが……どうやら、湖畔のようだ。
			WSTR:(K++) = 当然だが、リゾートとは植生や空気が全く違う。東の空域にある島々に似ている気がするが……。
			WSTR:(K++) = ともあれここでは余所者だ。霧も濃いし、気を付けて進もう。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_2_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 2
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "4_4")
	CASE "マスイベント"
		KSTR:(K++) = 結構大きな湖のようだ。冷気が漂ってくる……
		CALL 接続ルート全開放処理(マス深度, マス分岐)
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_4_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 4
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "5_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 紅の霧の中を、黒々とした球？　が、飛んでいる……
			WSTR:(K++) = あれはなんだろうか。手がかりもないし、追いかけてみようか？
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = 特に周囲に変わったところはない。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_5_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 5
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "7_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 黒い球の少女と戦った場所だ。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[宵闇の妖怪]ルーミア"),100,,,1,1)
			LOCALS = %立ち絵リソース記録%
			CALLF 任意顔グラ表示用文字列関数(キャラ検索("[宵闇の妖怪]ルーミア"),"顔_デフォルト_差分_表情",101)
			LOCALS:1 = %立ち絵リソース記録%
			WSTR:(K++) = 黒い球を追いかけていると、林に行き会った。
			WSTR:(K++) = 黒い球は、樹に触れ……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あいたっ」
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……と、黒い球の中から、声が聞こえてきた（ごちーん、と痛そうな音もだ）。
			WSTR:(K++) = 黒い球がほどけるように消え、中から額を押さえた金髪の少女が現れた。
			WSTR:(K++) = なにか魔法的手段で飛んでいたのだろうか？
			WSTR:(K++) = ともあれ、どうやら言葉は通じそうだ。話を聞いてみよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あいたた……あれ？　あんたは誰？」
			CALL メッセージ欄表示用関数(LOCALS:1,"黒い球の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = この紅い霧について調査をしている者だ、と答える。なにか心当たりはないだろうか？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「うーん、分からないかな。
			WSTR:(K++) = 　こっちからも聞いていい？
			WSTR:(K++) = 　あなたは、取って食べてもいい人類？」
			CALL メッセージ欄表示用関数(LOCALS,"黒い球の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……少女だと思ったが、人食いの、人でない存在らしい。
			WSTR:(K++) = 無邪気な殺気を表した黒い球の少女が襲ってきた！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv10_黒い球の少女
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 4
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;勝利後or読み返し中
			WSTR:(K++) = なんとか少女を退けた。
			WSTR:(K++) = どうやら、この幻想郷では、身一つで飛行するのが一般的であるようだ。
			WSTR:(K++) = 人影がないのは、先ほどの黒い球の少女のような存在がいることもあるだろうが、人が空を飛んでいるからだろうか……？
			WSTR:(K++) = ともあれ、ロクな手がかりにはならなかった。他を探してみよう。
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:7:4")
			SETBIT LOCAL, 1
			SETBIT LOCAL, 2
			CLEARBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:7:4", LOCAL
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_7_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 7
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 8
		ダンジョン現在位置:1 = 4
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 接続ルート全開放処理(8, 4)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_8_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 8
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "10_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 7
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_10_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 10
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "13_4")
	CASE "マスイベント"
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			WSTR:(K++) = 上空を、人影がふたつ通り過ぎていくのが見えた。
			WSTR:(K++) = 先ほどの黒い球の少女の件もあるが……手がかりもない。
			WSTR:(K++) = 今度こそは友好的な人物かもしれないし、追いかけてみよう。
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ELSE
			KSTR:(K++) = この先に人影がふたつ通り過ぎていった。
		ENDIF
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT




@ダンジョンマス情報_幻想郷紅魔異変_13_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_チルノ
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
マス深度 = 13
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "14_2")
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "14_6")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = ここは霊夢、魔理沙と出会い妖精たちと戦った場所だ。
			KSTR:(K++) = 霊夢と一緒にお茶をする：Ａのマスへ
			KSTR:(K++) = 飛んでいった魔理沙を追いかける：Ｂのマスへ
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[湖上の氷精]チルノ"),100,,,1,1)
			立ち絵_チルノ = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = これは戦闘の気配だろうか？　なにかが破裂する音と、強い冷気が伝わってくる。
			WSTR:(K++) = どちらかとは友好的に接触できるかもしれない。近づいてみよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ええい、寒いわねもう！　冷房病になりそう！」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"紅白の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「これは半袖じゃ体に悪いぜ！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女風の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「英吉利牛と一緒に冷凍保存される覚悟はできたかしら！」
			CALL メッセージ欄表示用関数(立ち絵_チルノ,"青髪の童女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 青髪の童女の背には氷の羽が浮いている。どうやら人間ではないようだ。
			WSTR:(K++) = 魔法なのか、自在に氷を操っているが、あまり知性が高いようにも見えない。
			WSTR:(K++) = 対する二人の少女は……おそらくは……人間だ。
			WSTR:(K++) = 加勢する、と、ふたりの少女に声をかける。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「任せたぜ、さっむい！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女風の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あ、じゃあお願いね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"紅白の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……任されるまでは考えていなかったなぁ……！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv12_氷の羽を持つ少女
			敵BATTLE_STATE_STR:4:エネミー名 = Lv9_妖精のような少女
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 10
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%

			WSTR:(K++) = 「おお～、結構やるのね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"紅白の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ここらじゃ見ない顔だな？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔女風の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 二人の少女は、それぞれ、霊夢、魔理沙、と名乗った。
			WSTR:(K++) = ちぱちぱ、と拍手してくれるふたりに頷き、説明をする。
			WSTR:(K++) = かくかくしかじかで、この幻想郷にちょっとやってきたのだが……。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「へえ、観光地の経営者？　行楽とかしてみたいわ～」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 魔理沙が、霊夢を指さし、のんき、と呟いた。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「分かってるわよ、行くにしてもこの異変が終わったあとね。
			WSTR:(K++) = 　……と言っても、あまり手がかりもつかんでないんだけど。
			WSTR:(K++) = 　なんとなくこのあたりな気はするわね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「霧も、このあたりが一番濃いしな。
			WSTR:(K++) = 　このあたり、なんかあったか？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「うーん、誰か館ごと引っ越してきたとかだっけ……？」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = なるほど。その館とやらが第一候補だろうか？
			WSTR:(K++) = 見つけたら、連絡したほうがいいだろうか……と言っても、連絡手段もないが。
			WSTR:(K++) = どちらかに付いていったほうがいいだろうか？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あんたが解決してくれてもいいわよ別に」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「じゃー早い者勝ちかな。私はこっちに行くぜ」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = いうが早いか、魔理沙は箒に乗って飛び去って行った。
			WSTR:(K++) = 霊夢はため息を吐き、言う。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「たぶんこっちのほう……だと思うんだけど、ちょっと体が冷えちゃったわ。
			WSTR:(K++) = 　いったん私は、お茶を飲んでから行くわね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = そう言って、霊夢は道端に腰掛け、袖から竹筒を取り出した。
			WSTR:(K++) = せっかく会えた友好的な現地人だ。二人のどちらかについていくべきだろうが……。
			WSTR:(K++) = 霊夢と一緒にお茶をする：Ａのマスへ
			WSTR:(K++) = 飛んでいった魔理沙を追いかける：Ｂのマスへ
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
			SETBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
			SETBIT LOCAL, 3
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_14_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_霊夢
#DIM 返答フラグ
マス深度 = 14
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原
		ダンジョンマス画像URL_重ね表示 = Ａマーク
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_2")
	CASE "マスイベント"
		IF 分岐封印判定(条件_クリア済み, "14-2", "14-6")
			KSTR:(K++) = この選択肢はダンジョンクリアまで封印されています。
			;フラグをリセット
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
			SETBIT LOCAL, 3
			CLEARBIT LOCAL, 2
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ELSE
			RFLAG:ダンジョン再視聴フラグ = 0
			IF 初来訪マス判定用フラグ
				;最初に訪れた時
				SETBIT RFLAG:ダンジョン再視聴フラグ, 0
				SETBIT RFLAG:ダンジョン再視聴フラグ, 1
				SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			ELSE
				KSTR:(K++) = 霊夢と一緒に行く。
				CALL 再視聴確認(1)
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
				;立ち絵リソース記録に必要な画像のリソースを生成する
				CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),100,,,1,1)
				立ち絵_霊夢 = %立ち絵リソース記録%
				WSTR:(K++) = 「ん？　なにか用？」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
				CALL 口上変数初期化
				KSTR:(K++) = 霊夢についていきますか？
				KSTR:(K++) = BUTTON_[はい]
				KSTR:(K++) = BUTTON_[いいえ]
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				$LOOP_MESSAGE
				INPUTS
				SELECTCASE RESULTS
					CASE "[はい]"
						WSTR:(K++) = 土地勘もないし、一緒に行きたいと霊夢に告げる。
						WSTR:(K++) = 少女は大して考えた様子もなく、どうでも良さげに同行を許可した。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「いいわよ別に。はぐれたら置いてくけど」
						CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
						CALL 口上変数初期化
						WSTR:(K++) = お茶を飲み終わった霊夢はふわりと浮き上がり、%CALLNAME:PLAYER%を一瞥もせずにどこかへ飛んでいく。
						WSTR:(K++) = 呆けていたら本気で置いていかれそうだ。すぐに追いかけよう。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						返答フラグ = 1
					CASE "[いいえ]"
						WSTR:(K++) = いや、もう少しどちらに付いていくか考えよう。
						WSTR:(K++) = 霊夢にはなんでもない、と返す。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「何よ、変なヤツね」
						WSTR:(K++) = 霊夢はまたお茶を飲み始めた……。
						CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
						CALL 口上変数初期化
						返答フラグ = 2
					CASEELSE
						CLEARLINE 1
						REUSELASTLINE  
						GOTO LOOP_MESSAGE
				ENDSELECT
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
				;戦闘部分
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				;再視聴では通らない報酬部分
				IF 返答フラグ == 1
					CALL 接続ルート全開放処理(マス深度, マス分岐)
					CALL 踏破マス開放処理(15, 2)
					CALL 分岐マス選択セット(マス深度, マス分岐)
				ELSEIF 返答フラグ == 2
					;いいえ時、フラグをリセット
					LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:2")
					SETBIT LOCAL, 3
					CLEARBIT LOCAL, 2
					SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:2", LOCAL
				ENDIF
			ENDIF
			RFLAG:ダンジョン再視聴フラグ = 0
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ENDIF
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_14_6(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_魔理沙
#DIM 返答フラグ
マス深度 = 14
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = Ｂマーク
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "15_6")
	CASE "マスイベント"
		IF 分岐封印判定(条件_クリア済み, "14-2", "14-6")
			KSTR:(K++) = この選択肢はダンジョンクリアまで封印されています。
			;フラグをリセット
			LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
			SETBIT LOCAL, 3
			CLEARBIT LOCAL, 2
			SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ELSE
			RFLAG:ダンジョン再視聴フラグ = 0
			IF 初来訪マス判定用フラグ
				;最初に訪れた時
				SETBIT RFLAG:ダンジョン再視聴フラグ, 0
				SETBIT RFLAG:ダンジョン再視聴フラグ, 1
				SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			ELSE
				KSTR:(K++) = 飛んでいった魔理沙を追いかける。
				CALL 再視聴確認(1)
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
				;立ち絵リソース記録に必要な画像のリソースを生成する
				CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),100,,,1,1)
				立ち絵_魔理沙 = %立ち絵リソース記録%
				KSTR:(K++) = 飛んでいった魔理沙を追いかけますか？
				KSTR:(K++) = BUTTON_[はい]
				KSTR:(K++) = BUTTON_[いいえ]
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				$LOOP_MESSAGE
				INPUTS
				SELECTCASE RESULTS
					CASE "[はい]"
						WSTR:(K++) = 土地勘もないし、ここは飛んでいった魔理沙を追いかけよう。
						WSTR:(K++) = 空に向かって手を振りながら追いかけると、気付いた魔理沙が戻ってきてくれた。
						WSTR:(K++) = 一緒に行きたいと伝えると、少女は快諾してくれる。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「構わないぜ。そっちも結構やるみたいだしな」
						CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
						CALL 口上変数初期化
						WSTR:(K++) = 魔理沙は１ｍほどの高さで飛び、%CALLNAME:PLAYER%たちに速度を合わせてくれる。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						WSTR:(K++) = 「じゃ、行こうぜ。お茶でも出してくれるお屋敷探しに」
						CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
						CALL 口上変数初期化
						返答フラグ = 1
					CASE "[いいえ]"
						WSTR:(K++) = いや、もう少しどちらに付いていくか考えよう。
						CALL メッセージ欄表示用関数(,,,0)
						CALL 口上変数初期化
						返答フラグ = 2
					CASEELSE
						CLEARLINE 1
						REUSELASTLINE  
						GOTO LOOP_MESSAGE
				ENDSELECT
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
				;戦闘部分
			ENDIF
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				;再視聴では通らない報酬部分
				IF 返答フラグ == 1
					CALL 接続ルート全開放処理(マス深度, マス分岐)
					CALL 踏破マス開放処理(15, 6)
					CALL 分岐マス選択セット(マス深度, マス分岐)
				ELSEIF 返答フラグ == 2
					;いいえ時、フラグをリセット
					LOCAL = GETVAR(@"ダンジョン構造配列_%ダンジョン名%:14:6")
					SETBIT LOCAL, 3
					CLEARBIT LOCAL, 2
					SETVAR @"ダンジョン構造配列_%ダンジョン名%:14:6", LOCAL
				ENDIF
			ENDIF
			RFLAG:ダンジョン再視聴フラグ = 0
			CALL メッセージ欄表示用関数(,,,0)
			CALL 画面再描画
		ENDIF
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_15_2(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(16, 2)
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 2
		ダンジョンマス画像URL_伏せ状態 = 壁_街
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_15_6(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 15
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(16, 6)
		ダンジョン現在位置:0 = 16
		ダンジョン現在位置:1 = 6
		ダンジョンマス画像URL_伏せ状態 = 壁_街
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_16_2(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "18_2")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン背景画像 = 背景_紅い霧砂浜
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 2
		ダンジョンマス画像URL_伏せ状態 = 壁_森
		CALL 画面再描画
ENDSELECT

@ダンジョンマス情報_幻想郷紅魔異変_16_6(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 16
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_草原

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "19_6")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン背景画像 = 背景_紅い霧砂浜
		ダンジョン現在位置:0 = 15
		ダンジョン現在位置:1 = 6
		ダンジョンマス画像URL_伏せ状態 = 壁_森
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_18_2(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_美鈴
マス深度 = 18
マス分岐 = 2

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅い霧砂浜
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 霊夢と一緒に門番である紅美鈴と戦った。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),100,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[華人小娘]紅美鈴"),101,,,1,1)
			立ち絵_美鈴 = %立ち絵リソース記録%
			WSTR:(K++) = 霊夢を追いかけて湖畔を行くうちに、霧がどんどん濃くなっていることに気付く。
			WSTR:(K++) = それに加え、何か……館だろうか？　高い塀の影が見えてきた。
			WSTR:(K++) = 更に近づくうち、正面に門扉も見えてくる。
			WSTR:(K++) = そこにはイデルバ王国の服装に似た衣装をまとった少女が、立ったまま居眠りしていた。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「すぴー…………」
			WSTR:(K++) = 起こすのが忍びないほど、幸せそうに眠っている……
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"赤毛の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「とりゃっ」
			WSTR:(K++) = 霊夢は躊躇なく御幣で赤毛の少女を叩き起こした！
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「んぬあっ寝てません寝てません……って、あれ、お客さんですか？
			WSTR:(K++) = 　紅魔館にようこそ」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"赤毛の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 彼女は頭を振って、頭をしゃっきりさせたようだ。
			WSTR:(K++) = 姿勢を正した彼女に、紅の霧について心当たりがないか、聞いてみる。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「えっ、なんで知って、いえ、あ、ありませんよ、心当たり。イヤだなー」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"赤毛の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……それは『なにかある』という顔と声と言葉のような気がする。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「くっ、バレたか……！　お嬢様のため、侵入者を通すわけにはいかない！」
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"赤毛の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = いやまだ侵入するとも決めていないのだが……
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「巫女をやってる普通の人を捕まえて侵入者なんて、ひどい妖怪ね。
			WSTR:(K++) = 　ほら、さっさと一緒にぶちのめすわよ」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 赤毛の少女が襲ってきた！
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv14_赤毛の格闘少女
			戦闘時_特殊処理フラグ = 霊夢の助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 2
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),100,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[華人小娘]紅美鈴"),101,,,1,1)
			立ち絵_美鈴 = %立ち絵リソース記録%
			WSTR:(K++) = 「くそ、背水の陣だ！」
			WSTR:(K++) = 言い捨て、少女は館へ走っていく。
			CALL メッセージ欄表示用関数(立ち絵_美鈴,"赤毛の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「道案内してくれるなんて親切ね。さっさと進みましょ」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 霊夢は楽観的にすたすたと進んでいく。
			WSTR:(K++) = しかし館には他にも人員がいるだろうし、それが先ほどの彼女のような、戦える者の可能性は高い。
			WSTR:(K++) = 気を付けて進もう。まさか、ひとりで『陣』とのたまうわけもあるまいし。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_19_6(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_パチュリー
#DIMS 立ち絵_小悪魔
マス深度 = 19
マス分岐 = 6

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "21_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅魔館
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 魔理沙と一緒に図書館でパチュリーと戦った。
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			ダンジョン背景画像 = 背景_紅い霧砂浜
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			WSTR:(K++) = 魔理沙と一緒に湖畔を行くうちに、霧がどんどん濃くなっていることに気付く。
			WSTR:(K++) = それに加え、何か……館だろうか？　高い塀の影が見えてきた。
			WSTR:(K++) = 更に近づくうち、正面に門扉も見えてくる。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = しかし、周囲には誰もいないようだ。
			WSTR:(K++) = 戦闘の跡が残っているところを見ると、先に霊夢が来ていたのだろうか？
			WSTR:(K++) = 門の向こうにある屋敷を見ると、壁から屋根まで真っ赤に塗られている。どう見ても怪しい。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「邪魔するぜー。ついでに邪魔以外もするぜ」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 魔理沙は臆せずにずかずかと屋敷の中へ入っていく。
			WSTR:(K++) = デザインからして紅い霧と無関係ではなさそうだ。%CALLNAME:PLAYER%たちも魔理沙の後に続き、屋敷へと侵入する。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			ダンジョン背景画像 = 背景_紅魔館
			WSTR:(K++) = 館に侵入すると、妙な違和感を覚える。
			WSTR:(K++) = ……大きな屋敷ではあったが、さすがに外見に見合わないほど広い。
			WSTR:(K++) = 天井は広く、廊下も広く――身一つで飛べる少女たちなら、空中戦すら可能だろう。
			WSTR:(K++) = もしもここで軍勢めいた敵に襲われたらひとたまりもない。
			WSTR:(K++) = 注意して進むことにしよう……。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 歩みを進めていくが…………なんだか、誰もいない気がする……
			WSTR:(K++) = この広さの館、人口密度が低くなるのは分かるが……
			WSTR:(K++) = 曲がりなりにも侵入者相手に、誰も来ないというのはいいのだろうか。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = そうして誰にも会わずに屋敷の中をうろついていると、変わった香りが漂ってくる。
			WSTR:(K++) = ……これは、紅茶の香りだろうか……？
			WSTR:(K++) = どうやら、近くの部屋から漂ってきているらしい。
			WSTR:(K++) = 入ってみることにしよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 扉を開けて入ってみると、図書館めいた空間が広がっていた。
			WSTR:(K++) = 薄暗く、かび臭い……整理も追いついていなさそうだ。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「わぁ、本がいっぱいだ。後でさっくり借りていこう」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 侵入者に貸してくれるだろうか？　などと喋りながら歩いていると、くるくると回転し飛行する本を見つけた。
			WSTR:(K++) = この幻想郷ではなんでも飛ぶのだろうか――などと考えていると、本が光を貯めこみ始めた。おそらく、攻撃の兆候だろう。
			WSTR:(K++) = ……と、のんきに考えているヒマではなかった！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「おっ、ちょうど暇してたところだ。一緒にぶっ飛ばそうぜ！」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 本の使い魔が襲ってきた！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:2:エネミー名 = Lv9_本の使い魔
			敵BATTLE_STATE_STR:5:エネミー名 = Lv9_本の使い魔
			敵BATTLE_STATE_STR:6:エネミー名 = Lv9_本の使い魔
			戦闘時_特殊処理フラグ = 魔理沙の助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 6
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[動かない大図書館]パチュリー・ノーレッジ"),101,,,1,1)
			立ち絵_パチュリー = %立ち絵リソース記録%
			WSTR:(K++) = 「そこの！　私の図書館で暴れない！」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 本を撃破したところ、紫色の少女と、黒い制服めいた衣装の悪魔っぽい少女がやってきた。
			WSTR:(K++) = 紅茶の香りがする……彼女が飲んでいたのだろうか？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「あなた、何者？　いちおう門番はいたと思うんだけど」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「いなかったぜ。いや、さっきの本のタイトルが『門番』だったかも」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = かくかくしかじかで、紅い霧を止めにきた。と質問に答える。
			WSTR:(K++) = あなたはこの館の主だろうか？　霧を出しているのなら、止めてほしい。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ふぅん。じゃあ、レミ────館の主には絶対会わせないわ」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……この幻想郷ではみんな血の気が多いのだろうか？
			WSTR:(K++) = 紫色の少女が襲い掛かってきた！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv14_紫色の少女
			敵BATTLE_STATE_STR:4:エネミー名 = Lv10_悪魔っぽい少女
			戦闘時_特殊処理フラグ = 魔理沙の助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 16
				ダンジョン現在位置:1 = 6
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),100,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[動かない大図書館]パチュリー・ノーレッジ"),101,,,1,1)
			立ち絵_パチュリー = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[名もなき小さな悪魔]小悪魔"),102,,,1,1)
			立ち絵_小悪魔 = %立ち絵リソース記録%
			WSTR:(K++) = 「むきゅ～……」
			CALL メッセージ欄表示用関数(立ち絵_パチュリー,"紫色の少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ぱ、パチュリー様……！」
			CALL メッセージ欄表示用関数(立ち絵_小悪魔,"悪魔っぽい少女",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 潰れてしまった紫色の少女を、悪魔っぽい少女が抱えて逃げて行った。
			WSTR:(K++) = 逃げて行った先になにかあるかもしれない。追いかけよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「そろそろ黒幕に近づいてきたか？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_21_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
マス深度 = 21
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "23_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		ダンジョン背景画像 = 背景_紅魔館
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
			IF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4)
				;霊夢ルート
				CLEARBIT RFLAG:ダンジョン再視聴フラグ, 4
			ELSE
				;魔理沙ルート
				SETBIT RFLAG:ダンジョン再視聴フラグ, 4
			ENDIF
		ELSE
			$再視聴表示
			IF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4) && GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:6, 4)
				IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4)
					;霊夢ルート
					KSTR:(K++) = 霊夢と一緒に咲夜と戦い、魔理沙と合流した。　　　_BUTTON_[ルートを切り替え]
				ELSE
					;魔理沙ルート
					KSTR:(K++) = 魔理沙と一緒に咲夜と戦い、霊夢と合流した。　　　_BUTTON_[ルートを切り替え]
				ENDIF
			ELSEIF GETBIT(ダンジョン構造配列_幻想郷紅魔異変:14:2, 4)
				;霊夢ルート
				CLEARBIT RFLAG:ダンジョン再視聴フラグ, 4
				KSTR:(K++) = 霊夢と一緒に咲夜と戦い、魔理沙と合流した。
			ELSE
				;魔理沙ルート
				SETBIT RFLAG:ダンジョン再視聴フラグ, 4
				KSTR:(K++) = 魔理沙と一緒に咲夜と戦い、霊夢と合流した。
			ENDIF
			CALL 再視聴確認(0, "[ルートを切り替え]")
			SIF RESULT
				GOTO 再視聴表示
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完全で瀟洒な従者]十六夜咲夜"),100,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4) == 0
				;霊夢ルート
				WSTR:(K++) = 廊下を進んでいると、物音が聞こえた。
				WSTR:(K++) = 先ほどの門番の少女だろうか？　今度こそ話を聞ければいいが……。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「ああもう、お掃除が進まない！　妖精でもいいから、メイドを雇うべきかしら！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"メイドの少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「あなた……は、ここの主人じゃなさそうね」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 彼女は、こちらを発見すると、ぱっ、と、眼前に現れた。
				WSTR:(K++) = 瞬間移動の類だろうか？
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「あなたがたは？　お嬢様のお客様でしょうか……って、私が把握してないわけないし。侵入者よね。
				WSTR:(K++) = 　美鈴はなにをしていたのかしら……
				WSTR:(K++) = 　申し遅れたけれど、私はここのメイド長の咲夜。
				WSTR:(K++) = 　零秒でお掃除させてもらうわ！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「せっかちなメイドね。騒ぎを起こすのは望むところだけど」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
				CALL 口上変数初期化
				WSTR:(K++) = メイド長、咲夜が襲い掛かって……
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「待った待った！　ようやく追いついたぜ。
				WSTR:(K++) = 　見せ場を逃さないのも良い魔女の条件だ」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「あら、もう追いついてきたの」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 後ろから凄い速度で飛んできた魔理沙が、勢いのまま加勢する。
				WSTR:(K++) = では改めて。メイド長、咲夜が襲い掛かってきた！
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			ELSE
				;魔理沙
				WSTR:(K++) = 図書館の二人を追いかけて廊下を進んでいると、近くから戦闘音が聞こえてきた。
				WSTR:(K++) = 音の方に進むと、霊夢とメイド服姿の少女が戦っている！
				WSTR:(K++) = 加勢をしようと魔理沙と一緒に霊夢の側へと駆け寄った。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「あら、もう追いついてきたの」
				CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
				CALL 口上変数初期化
				WSTR:(K++) = メイド服姿の少女は警戒しているのか、一旦距離を取って構えている。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「ああもう、お掃除で忙しいのに！　あっちにもこっちにも邪魔者ばかり！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"メイドの少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「失敬な。邪魔以外もするぜ」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「じゃあ掃除……はあんたじゃ出来無さそうね。そっちのは得意そうだけど」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"メイドの少女",,0)
				CALL 口上変数初期化
				IF 仕事レベル:PLAYER:1 >= 3
					WSTR:(K++) = 雑務については確かに得意分野だが……
				ELSE
					WSTR:(K++) = 雑務については少しばかり腕に覚えがあるが……
				ENDIF
				WSTR:(K++) = それよりもこの紅い霧について話を聞かせてもらえないだろうか。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「確かに霧はうちで出してるわ。日光も遮れるし、お嬢様、冥い好きだし」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"メイドの少女",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 止めてもらえないだろうか。うちの近くにまで流れてきて迷惑しているので。
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「それはお嬢様が決めることで、邪魔者はお嬢様には会わせない。
				WSTR:(K++) = 　申し遅れたけれど、私はここのメイド長の咲夜。
				WSTR:(K++) = 　零秒でお掃除させてもらうわ！」
				CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
				CALL 口上変数初期化
				WSTR:(K++) = 「ってことは、こいつを倒せば私がメイド長だな」
				CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
				CALL 口上変数初期化
				WSTR:(K++) = メイド長、咲夜が襲い掛かってきた！
				CALL メッセージ欄表示用関数(,,,0)
				CALL 口上変数初期化
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv16_メイド長の咲夜
			戦闘時_特殊処理フラグ = 霊夢と魔理沙の助力_紅魔事変
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 4) == 0
					ダンジョン現在位置:0 = 18
					ダンジョン現在位置:1 = 2
				ELSE
					ダンジョン現在位置:0 = 19
					ダンジョン現在位置:1 = 6
				ENDIF
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完全で瀟洒な従者]十六夜咲夜"),100,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),101,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),102,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 「強い……変なやつらね。外の人間とも違う……」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 仮にも異世界から来ているので――そう答えたところで、どこからか、高い、童女の声が聞こえてきた。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 『いいわ。お通ししなさい、咲夜』
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「お嬢様！？」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 『外の、さらに外の世界からの客人なんて、紅魔館が最初にお迎えするにふさわしいじゃない。
			WSTR:(K++) = 　そんな客人の血は、どんな味がするのかしら。楽しみだわ』
			CALL メッセージ欄表示用関数(,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ばさばさと、室内であるにもかかわらず、蝙蝠が飛び去って行く。
			WSTR:(K++) = 咲夜は、ため息を吐いて、こちらに向き直った。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「それではご案内させていただきます、お客様」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 拒否する選択肢は……なさそうだ。
			WSTR:(K++) = 招待されたのだから、断るのも失礼だろう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「冷えてた身体は温まっちゃったぜ。もうお茶はいらないかな」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「甘いおまんじゅうでも期待したいところね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_23_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 23
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 右アイコン
	CASE "接続先"
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		CALL 接続ルート全開放処理(24, 4)
		ダンジョン現在位置:0 = 24
		ダンジョン現在位置:1 = 4
		ダンジョン背景画像 = 背景_紅魔館
		;移動直後はマスイベント発動しないので、移動先のマス開放をここで行う
		CALL 踏破マス開放処理
		CALL 画面再描画
ENDSELECT


@ダンジョンマス情報_幻想郷紅魔異変_24_4(ARGS)
#DIM マス深度
#DIM マス分岐
マス深度 = 24
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 左アイコン
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "26_4")
	CASE "マスイベント"
		;移動先Yと移動先Yを、移動先の位置に変更すること
		ダンジョン現在位置:0 = 23
		ダンジョン現在位置:1 = 4
		CALL 画面再描画
ENDSELECT



@ダンジョンマス情報_幻想郷紅魔異変_26_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_レミリア
マス深度 = 26
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = エネミーアイコン_赤
	CASE "接続先"
		CALL ダンジョン分岐線描画(@"{マス深度}_{マス分岐}", "30_4")
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 異変の黒幕であるレミリアと戦った
			CALL 再視聴確認(0)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[永遠に紅い幼き月]レミリア"),100,,,1,1)
			立ち絵_レミリア = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完全で瀟洒な従者]十六夜咲夜"),101,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),102,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),103,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 案内された先は、広いバルコニーだった。
			WSTR:(K++) = そこには、白いドレスに身を包んだ童女が、なにか紅い茶を飲んでいる。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「ようこそ。
			WSTR:(K++) = 　私は、この紅魔館の主、レミリア・スカーレット。
			WSTR:(K++) = 　あなたは？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"？？？",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 名乗り返すと、彼女――レミリアは頷き、立ち上がった。
			WSTR:(K++) = 小さい。
			WSTR:(K++) = ヒューマンの、10歳の子供くらいの背丈だろうか？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = ただ、見かけ通りの年齢ではなさそうだし……見かけ通りの力でもないだろう。
			WSTR:(K++) = 見て取れるほど強大な魔力が渦巻いている……。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「それで？　わざわざこの紅魔館まで来た理由は？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 異界の門を通じて、霧がこちらの世界にまで漏れている。
			WSTR:(K++) = こちらとしては、幻想郷という、潜在的な顧客も多いであろう土地との交流を断ちたくない。
			WSTR:(K++) = ……リゾート優待券１年分とかで手を打っていただけないだろうか？
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「リゾート？　へえ……優待券？　ふぅん。面白いことを言うのね。え、経営してるのかしら？」
			WSTR:(K++) = 頷けば、レミリアは、少し興味深そうな顔をした。
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「いいわ。一年分の優待券は貰っておいてあげる。
			WSTR:(K++) = 　霧もそっちの世界には行かないよう、うちの魔法使いに相談してあげるわ」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 完全に止めていただきたいのだが、そうもいかないだろうか。
			WSTR:(K++) = 外の世界からやってきておいて、あまり強く言うこともできないが……。
			WSTR:(K++) = 答えに迷ったところで、同行していた二人の少女が前に出る。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「それじゃ困るんだよな」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「さっさと霧を止めてもらえるかしら」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……レミリアは、明らかに不快な表情になった。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「咲夜。そっちのふたりは任せたわ」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「かしこまりました」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 咲夜の姿がかき消え、同時、霊夢と魔理沙の姿も消えた。
			WSTR:(K++) = 数秒後、上空から、戦闘の音が聞こえてくる……
			WSTR:(K++) = レミリアは、気を取り直したように、頷いた。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「じゃあ、こうしましょうか。
			WSTR:(K++) = 　霧は止めてあげるわ。
			WSTR:(K++) = 　そして、これから私がお前を殺すわね」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「お前が生き残れたら、それでおしまい。リゾートに普通にお客として行くわ。
			WSTR:(K++) = 　お前が死んだら、私が屍生人(ゾンビ)にして、お前のリゾートを、私専用のリゾートにしてあげる」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……リゾート乗っ取りは困るな。
			WSTR:(K++) = レミリアが羽を広げる。
			WSTR:(K++) = 紅霧が引き裂かれ、真っ赤な満月が、露わになる。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「こんなに月も紅いから――」
			WSTR:(K++) = 
			WSTR:(K++) = ――出迎えなさいね？　尋ねる夜には。
			WSTR:(K++) = 歓迎いたします、ご来訪の夜には――。
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 1)
			;戦闘部分
			敵BATTLE_STATE_STR:0:エネミー名 = Lv18_吸血鬼レミリア
			CALL 雑魚敵遭遇汎用処理
			IF RESULT != 0 && GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
				CALL マス未踏破戻し処理(ダンジョン現在位置:0, ダンジョン現在位置:1)
				ダンジョン現在位置:0 = 24
				ダンジョン現在位置:1 = 4
				RETURN 0
			ENDIF
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CALL 接続ルート全開放処理(マス深度, マス分岐)
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT





@ダンジョンマス情報_幻想郷紅魔異変_30_4(ARGS)
#DIM マス深度
#DIM マス分岐
#DIMS 立ち絵_咲夜
#DIMS 立ち絵_魔理沙
#DIMS 立ち絵_霊夢
#DIMS 立ち絵_レミリア
マス深度 = 30
マス分岐 = 4

SELECTCASE ARGS
	CASE "マス画像"
		ダンジョンマス画像URL = 床_街

		ダンジョンマス画像URL_重ね表示 = 会話アイコン
	CASE "接続先"
	CASE "マスイベント"
		RFLAG:ダンジョン再視聴フラグ = 0
		IF 初来訪マス判定用フラグ
			;最初に訪れた時
			SETBIT RFLAG:ダンジョン再視聴フラグ, 0
			SETBIT RFLAG:ダンジョン再視聴フラグ, 1
			SETBIT RFLAG:ダンジョン再視聴フラグ, 10
		ELSE
			KSTR:(K++) = 異変を解決し、新たなリゾートの顧客を獲得した。
			CALL 再視聴確認(1)
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 0)
			;立ち絵リソース記録に必要な画像のリソースを生成する
			CALLF 顔グラ表示用文字列関数(キャラ検索("[永遠に紅い幼き月]レミリア"),100,,,1,1)
			立ち絵_レミリア = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[完全で瀟洒な従者]十六夜咲夜"),101,,,1,1)
			立ち絵_咲夜 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[普通の魔法使い]霧雨魔理沙"),102,,,1,1)
			立ち絵_魔理沙 = %立ち絵リソース記録%
			CALLF 顔グラ表示用文字列関数(キャラ検索("[楽園の素敵な巫女]博麗霊夢"),103,,,1,1)
			立ち絵_霊夢 = %立ち絵リソース記録%
			WSTR:(K++) = 異界の門を調整する。
			WSTR:(K++) = これで幻想郷との間が安定するようになったし、紅の霧が再発生しても、こちらに流れてくることはない。
			WSTR:(K++) = 設置したのは我々なので、管理もこちらでやるが、たまに気にかけてくれると嬉しい――
			WSTR:(K++) = 霊夢たちは頷き、お茶をすすった。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「まあうまくやるわ。……ところで、私もそのリゾート？　に行っていいのかしら。
			WSTR:(K++) = 　あんまり、手持ちのお金、って私持ってないんだけど」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「え、お前、銭ってあるのか？　賽銭入れに来る参拝客もいないのに？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「お賽銭はないけど、ご厚意はたくさん持ってるのよ、私」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……まあ、ルピ建てで払っていただくのが一番だが……
			WSTR:(K++) = 幻想郷にも、空でも価値のある物品は存在するようだし、空にないもの、まったく別の理論で作られた物品もあるようだ。
			WSTR:(K++) = そういったものを持ち込んでいただければ、多少の融通は利かせよう。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「そう？　じゃあ、厚意ポイントが尽きたらお世話になりに行くわね」
			CALL メッセージ欄表示用関数(立ち絵_霊夢,"霊夢",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「じゃあ今から帰るのに付いて行ったほうがいいんじゃないか？」
			CALL メッセージ欄表示用関数(立ち絵_魔理沙,"魔理沙",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 喧嘩し始めた紅白と白黒から視線を外す。
			WSTR:(K++) = 陽光の下、日傘をさした童女――レミリアと、メイド、咲夜が歩み寄ってきている。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「この先にリゾートがあるのかしら？
			WSTR:(K++) = 　予定を開けて向かおうかしらね。社員旅行ってやつ？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「お嬢様、私どもは社員というわけでは……
			WSTR:(K++) = 　それを言うなら、紅魔館ご一行ですわ」
			CALL メッセージ欄表示用関数(立ち絵_咲夜,"咲夜",,0)
			CALL 口上変数初期化
			WSTR:(K++) = 「なにか違うんだっけ、それ？」
			CALL メッセージ欄表示用関数(立ち絵_レミリア,"レミリア",,0)
			CALL 口上変数初期化
			WSTR:(K++) = ……これで、幻想郷の住人にも、リゾートの宣伝ができただろう。
			WSTR:(K++) = レミリアたちを招いて、評判を広めてもらうのもいいかもしれない。
			WSTR:(K++) = 経営計画を練り直すのが楽しみだ。
			WSTR:(K++) = さしあたり、幻想郷の住人は何を好むのか、リサーチしてから帰ることにしよう。
			WSTR:(K++) = 人肉しか食べられない者ばかりということもあるまい。たぶん……。
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [楽園の素敵な巫女]博麗霊夢がリゾートを訪れるようになった！
			WSTR:(K++) = [普通の魔法使い]霧雨魔理沙がリゾートを訪れるようになった！
			CALL メッセージ欄表示用関数(,,,0)
			CALL 口上変数初期化
			WSTR:(K++) = [華人小娘]紅美鈴がリゾートを訪れるようになった！
			WSTR:(K++) = [名もなき小さな悪魔]小悪魔がリゾートを訪れるようになった！
			WSTR:(K++) = [動かない大図書館]パチュリー・ノーレッジがリゾートを訪れるようになった！
			WSTR:(K++) = [完全で瀟洒な従者]十六夜咲夜がリゾートを訪れるようになった！
			WSTR:(K++) = [永遠に紅い幼き月]レミリアがリゾートを訪れるようになった！
		ENDIF
		IF GETBIT(RFLAG:ダンジョン再視聴フラグ, 10)
			;再視聴では通らない報酬部分
			CFLAG:(キャラ検索("[楽園の素敵な巫女]博麗霊夢")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[普通の魔法使い]霧雨魔理沙")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[華人小娘]紅美鈴")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[名もなき小さな悪魔]小悪魔")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[動かない大図書館]パチュリー・ノーレッジ")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[完全で瀟洒な従者]十六夜咲夜")):招待不可フラグ = 0
			CFLAG:(キャラ検索("[永遠に紅い幼き月]レミリア")):招待不可フラグ = 0
			ダンジョン終了状況 = 踏破達成
			ダンジョンクリアフラグ_幻想郷紅魔異変 = 1
		ENDIF
		RFLAG:ダンジョン再視聴フラグ = 0
		CALL メッセージ欄表示用関数(,,,0)
		CALL 画面再描画
ENDSELECT

